#!/usr/bin/env bash
# ============================================================================
# update-proof-ledger.sh
#
# Generate or verify top-level proof transparency docs:
#   - PROOF_STATUS.md
#   - AXIOMS.md
#
# Usage:
#   bash scripts/update-proof-ledger.sh
#   bash scripts/update-proof-ledger.sh --check
# ============================================================================

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
COQ_DIR="$REPO_ROOT/02_FORMAL/coq"
COQ_PROJECT="$COQ_DIR/_CoqProject"
CHECK_MODE=0

if [ "${1:-}" = "--check" ]; then
  CHECK_MODE=1
fi

if [ ! -f "$COQ_PROJECT" ]; then
  echo "ERROR: missing $COQ_PROJECT"
  exit 1
fi

tmp_status="$(mktemp)"
tmp_axioms="$(mktemp)"
tmp_active_axiom_sites="$(mktemp)"
tmp_active_assumption_sites="$(mktemp)"
trap 'rm -f "$tmp_status" "$tmp_axioms" "$tmp_active_axiom_sites" "$tmp_active_assumption_sites"' EXIT

mapfile -t active_coq_files < <(
  awk '
    {
      line=$0;
      sub(/^[ \t]+/, "", line);
      if (line ~ /^[#-]/ || line == "") next;
      split(line, tok, /[ \t]+/);
      if (tok[1] ~ /\.v$/) print tok[1];
    }
  ' "$COQ_PROJECT"
)

active_files_count="${#active_coq_files[@]}"
total_coq_files="$(find "$COQ_DIR" -name "*.v" -type f | wc -l | tr -d " ")"
inactive_files_count=$((total_coq_files - active_files_count))

active_qed=0
active_admitted=0
active_axioms=0
active_assumptions=0

for rel in "${active_coq_files[@]}"; do
  path="$COQ_DIR/$rel"
  [ -f "$path" ] || continue

  # Keep Qed counting aligned with scripts/generate-metrics.sh.
  qed_hits="$(grep -c 'Qed\.' "$path" || true)"
  admitted_hits="$(grep -Ec '^[[:space:]]*Admitted\.' "$path" || true)"
  axiom_hits="$(grep -Ec '^[[:space:]]*Axiom[[:space:]]+' "$path" || true)"
  assumption_hits="$(grep -Ec '^[[:space:]]*Parameter[[:space:]]+val_rel_n_step_up[[:space:]]' "$path" || true)"

  active_qed=$((active_qed + qed_hits))
  active_admitted=$((active_admitted + admitted_hits))
  active_axioms=$((active_axioms + axiom_hits))
  active_assumptions=$((active_assumptions + assumption_hits))

  grep -nE '^[[:space:]]*Axiom[[:space:]]+' "$path" | sed "s|^|$rel:|" >> "$tmp_active_axiom_sites" || true
  grep -nE '^[[:space:]]*Parameter[[:space:]]+val_rel_n_step_up[[:space:]]' "$path" | sed "s|^|$rel:|" >> "$tmp_active_assumption_sites" || true
done

global_admitted="$(find "$REPO_ROOT/02_FORMAL" -name "*.v" -type f -exec grep -Eh '^[[:space:]]*Admitted\.' {} + 2>/dev/null | wc -l | tr -d " ")"
global_axioms="$(find "$REPO_ROOT/02_FORMAL" -name "*.v" -type f -exec grep -Eh '^[[:space:]]*Axiom[[:space:]]+' {} + 2>/dev/null | wc -l | tr -d " ")"

cat > "$tmp_status" <<EOF
# RIINA Proof Status

This file is generated by \`scripts/update-proof-ledger.sh\`.
Do not edit this file manually.

## Active Build Snapshot
- Coq files (active via \`_CoqProject\`): $active_files_count
- Coq files (total in repository): $total_coq_files
- Coq files (inactive or archived): $inactive_files_count
- Qed proofs (active): $active_qed
- Admitted (active): $active_admitted
- Axioms (active): $active_axioms
- Explicit semantic assumptions (active): $active_assumptions

## Global Repository Snapshot (Includes Archived/Non-Active)
- Admitted (global): $global_admitted
- Axioms (global): $global_axioms

## Policy
- Production-active scope is defined by \`02_FORMAL/coq/_CoqProject\`.
- Production-active scope must keep:
  - \`Admitted = 0\`
  - \`Axioms = 0\`
  - \`Explicit semantic assumptions = 0\`

## Verification Commands
\`\`\`bash
bash scripts/update-proof-ledger.sh --check
03_PROTO/target/release/riinac verify --full
bash scripts/check-easier-gaps.sh
\`\`\`
EOF

{
  echo "# RIINA Axiom Ledger"
  echo ""
  echo "This file is generated by \`scripts/update-proof-ledger.sh\`."
  echo "Do not edit this file manually."
  echo ""
  echo "## Active Build (_CoqProject)"
  echo "- Axioms: $active_axioms"
  echo "- Explicit semantic assumptions: $active_assumptions"
  echo ""
  echo "### Active Axiom Sites"
  if [ -s "$tmp_active_axiom_sites" ]; then
    while IFS= read -r line; do
      echo "- \`$line\`"
    done < "$tmp_active_axiom_sites"
  else
    echo "- None."
  fi
  echo ""
  echo "### Active Explicit Semantic Assumption Sites"
  if [ -s "$tmp_active_assumption_sites" ]; then
    while IFS= read -r line; do
      echo "- \`$line\`"
    done < "$tmp_active_assumption_sites"
  else
    echo "- None."
  fi
  echo ""
  echo "## Global Repository (Includes Archived/Non-Active)"
  echo "- Axioms (global): $global_axioms"
  echo "- Admitted (global): $global_admitted"
  echo ""
  echo "## Notes"
  echo "- Global non-zero values can exist in archived/non-active files."
  echo "- Public production claims must use active-build values only."
} > "$tmp_axioms"

if [ "$CHECK_MODE" -eq 1 ]; then
  diff -u "$REPO_ROOT/PROOF_STATUS.md" "$tmp_status" >/dev/null
  diff -u "$REPO_ROOT/AXIOMS.md" "$tmp_axioms" >/dev/null
  echo "Proof ledgers are up to date."
  exit 0
fi

cp "$tmp_status" "$REPO_ROOT/PROOF_STATUS.md"
cp "$tmp_axioms" "$REPO_ROOT/AXIOMS.md"
echo "Updated PROOF_STATUS.md and AXIOMS.md"
