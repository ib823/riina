(* Copyright (c) 2026 The RIINA Authors. All rights reserved. *)

(*
 * RIINA PCIDSSCompliance - Isabelle/HOL Port
 *
 * Auto-generated port of 02_FORMAL/coq/compliance/PCIDSSCompliance.v (37 theorems).
 *
 * Generated by scripts/generate-multiprover.py
 *
 * Correspondence Table:
 *
 * | Coq Definition     | Isabelle Definition    | Status |
 * |--------------------|------------------------|--------|
 * | CHDType            | chd_type               | OK     |
 * | EncState           | enc_state              | OK     |
 * | PANDisplay         | pan_display            | OK     |
 * | AccessLevel        | access_level           | OK     |
 * | TLSVersion         | tls_version            | OK     |
 * | DeletionState      | deletion_state         | OK     |
 * | CHDRecord          | chd_record             | OK     |
 * | KeyState           | key_state              | OK     |
 * | PCIAudit           | pci_audit              | OK     |
 * | TokenVault         | token_vault            | OK     |
 * | PCISystem          | pci_system             | OK     |
 * | User               | user                   | OK     |
 * | Transmission       | transmission           | OK     |
 * | RetentionPolicy    | retention_policy       | OK     |
 * | NetworkZone        | network_zone           | OK     |
 * | can_store          | can_store              | OK     |
 * | pci_compliant_encryption | pci_compliant_encryption | OK     |
 * | display_compliant  | display_compliant      | OK     |
 * | key_needs_rotation | key_needs_rotation     | OK     |
 * | grant_chd_access   | grant_chd_access       | OK     |
 * | chd_record_compliant | chd_record_compliant   | OK     |
 * | create_audit_entry | create_audit_entry     | OK     |
 * | tls_compliant      | tls_compliant          | OK     |
 * | transmission_compliant | transmission_compliant | OK     |
 * | data_past_retention | data_past_retention    | OK     |
 * | deletion_secure    | deletion_secure        | OK     |
 * | deletion_unrecoverable | deletion_unrecoverable | OK     |
 * | zone_compliant     | zone_compliant         | OK     |
 * | system_scope_isolated | system_scope_isolated  | OK     |
 * | users_unique_ids   | users_unique_ids       | OK     |
 * | COMPLY_002_01_pan_masking | COMPLY_002_01_pan_masking | OK     |
 * | COMPLY_002_01_pan_masking_valid | COMPLY_002_01_pan_masking_valid | OK     |
 * | COMPLY_002_02_pan_encryption | COMPLY_002_02_pan_encryption | OK     |
 * | COMPLY_002_02_pan_plain_forbidden | COMPLY_002_02_pan_plain_forbidden | OK     |
 * | COMPLY_002_02_pan_aes128_insufficient | COMPLY_002_02_pan_aes128_insufficient | OK     |
 * | COMPLY_002_03_cvv_never_stored | COMPLY_002_03_cvv_never_stored | OK     |
 * | COMPLY_002_03_cvv_no_compliant_encryption | COMPLY_002_03_cvv_no_compliant_encryption | OK     |
 * | COMPLY_002_04_pin_never_stored | COMPLY_002_04_pin_never_stored | OK     |
 * | COMPLY_002_04_pin_no_compliant_encryption | COMPLY_002_04_pin_no_compliant_encryption | OK     |
 * | COMPLY_002_05_key_rotation_detection | COMPLY_002_05_key_rotation_detection | OK     |
 * | COMPLY_002_05_key_no_rotation_needed | COMPLY_002_05_key_no_rotation_needed | OK     |
 * | COMPLY_002_06_access_requires_need_to_know | COMPLY_002_06_access_requires_need_to_know | OK     |
 * | COMPLY_002_06_no_access_level_denied | COMPLY_002_06_no_access_level_denied | OK     |
 * | COMPLY_002_07_unique_ids_singleton | COMPLY_002_07_unique_ids_singleton | OK     |
 * | COMPLY_002_07_unique_ids_empty | COMPLY_002_07_unique_ids_empty | OK     |
 * | COMPLY_002_08_mfa_required | COMPLY_002_08_mfa_required | OK     |
 * | COMPLY_002_08_access_granted_implies_mfa | COMPLY_002_08_access_granted_implies_mfa | OK     |
 * | COMPLY_002_09_audit_entry_has_timestamp | COMPLY_002_09_audit_entry_has_timestamp | OK     |
 * | COMPLY_002_09_audit_entry_has_user | COMPLY_002_09_audit_entry_has_user | OK     |
 * | COMPLY_002_09_audit_entry_has_action | COMPLY_002_09_audit_entry_has_action | OK     |
 * | COMPLY_002_10_audit_has_hash | COMPLY_002_10_audit_has_hash | OK     |
 * | COMPLY_002_10_empty_log_valid | COMPLY_002_10_empty_log_valid | OK     |
 * | COMPLY_002_11_tls12_compliant | COMPLY_002_11_tls12_compliant | OK     |
 * | COMPLY_002_11_tls13_compliant | COMPLY_002_11_tls13_compliant | OK     |
 * | COMPLY_002_11_old_tls_non_compliant | COMPLY_002_11_old_tls_non_compliant | OK     |
 * | COMPLY_002_11_transmission_requires_encryption | COMPLY_002_11_transmission_requires_encryption | OK     |
 * | COMPLY_002_12_token_no_key_no_pan | COMPLY_002_12_token_no_key_no_pan | OK     |
 * | COMPLY_002_12_tokenization_irreversible_without_key | COMPLY_002_12_tokenization_irreversible_without_key | OK     |
 * | COMPLY_002_13_past_retention_detected | COMPLY_002_13_past_retention_detected | OK     |
 * | COMPLY_002_13_within_retention_ok | COMPLY_002_13_within_retention_ok | OK     |
 * | COMPLY_002_14_secure_deletion_unrecoverable | COMPLY_002_14_secure_deletion_unrecoverable | OK     |
 * | COMPLY_002_14_not_deleted_recoverable | COMPLY_002_14_not_deleted_recoverable | OK     |
 * | COMPLY_002_14_marked_still_recoverable | COMPLY_002_14_marked_still_recoverable | OK     |
 * | COMPLY_002_15_cde_requires_isolation | COMPLY_002_15_cde_requires_isolation | OK     |
 * | COMPLY_002_15_cde_requires_firewall | COMPLY_002_15_cde_requires_firewall | OK     |
 * | COMPLY_002_15_non_cde_always_compliant | COMPLY_002_15_non_cde_always_compliant | OK     |
 * | COMPLY_002_15_vault_isolation | COMPLY_002_15_vault_isolation | OK     |
 *)

theory PCIDSSCompliance
  imports Main
begin

(* Boolean conjunction helper (matches Coq: andb_true_iff) *)
lemma andb_true_iff: "(a \<and> b) = True \<longleftrightarrow> a = True \<and> b = True"
  by auto

(* CHDType (matches Coq: Inductive CHDType) *)
datatype chd_type =
    PAN  (* Primary Account Number - 16 digits *)
  |     CVV  (* Card Verification Value - 3-4 digits *)
  |     PIN  (* Personal Identification Number *)
  |     Expiry  (* Expiration date *)
  |     CardholderName  (* Cardholder name *)

(* EncState (matches Coq: Inductive EncState) *)
datatype enc_state =
    Plain
  |     AES128
  |     AES256  (* Minimum for PAN *)
  |     Tokenized  (* Tokenization *)

(* PANDisplay (matches Coq: Inductive PANDisplay) *)
datatype pan_display =
    FullPAN  (* PROHIBITED for display *)
  |     MaskedPAN  (* ****-****-****-1234 *)
  |     TokenizedPAN  (* Token reference *)

(* AccessLevel (matches Coq: Inductive AccessLevel) *)
datatype access_level =
    NoAccess
  |     ReadOnly
  |     ReadWrite
  |     Admin

(* TLSVersion (matches Coq: Inductive TLSVersion) *)
datatype tls_version =
    TLS10
  |     TLS11
  |     TLS12
  |     TLS13

(* DeletionState (matches Coq: Inductive DeletionState) *)
datatype deletion_state =
    NotDeleted
  |     MarkedForDeletion
  |     Overwritten  (* Data overwritten with random *)
  |     SecurelyDeleted  (* Multiple overwrites, verified *)

(* CHDRecord (matches Coq: Record CHDRecord) *)
record chd_record =
  chd_type :: CHDType
  chd_value :: nat  (* Abstract value *)
  chd_encryption :: EncState
  chd_display_format :: PANDisplay

(* KeyState (matches Coq: Record KeyState) *)
record key_state =
  key_id :: nat
  key_creation_time :: nat
  key_rotation_period :: nat  (* Typically 1 year *)
  key_protected :: bool  (* Stored in HSM or equivalent *)

(* PCIAudit (matches Coq: Record PCIAudit) *)
record pci_audit =
  pci_timestamp :: nat
  pci_user :: nat
  pci_action :: nat
  pci_chd_accessed :: CHDType
  pci_success :: bool
  pci_hash :: nat  (* For integrity *)

(* TokenVault (matches Coq: Record TokenVault) *)
record token_vault =
  vault_tokens :: 'a list
  vault_key :: KeyState  (* Key protecting the vault *)
  vault_isolated :: bool  (* Network segmented *)

(* PCISystem (matches Coq: Record PCISystem) *)
record pci_system =
  pci_chd_records :: 'a list
  pci_audit_log :: 'a list
  pci_keys :: 'a list
  pci_vault :: TokenVault

(* User (matches Coq: Record User) *)
record user =
  user_id :: nat
  user_access_level :: AccessLevel
  user_mfa_enabled :: bool
  user_need_to_know :: bool  (* Business need for CHD access *)

(* Transmission (matches Coq: Record Transmission) *)
record transmission =
  trans_tls_version :: TLSVersion
  trans_encrypted :: bool
  trans_chd_type :: CHDType

(* RetentionPolicy (matches Coq: Record RetentionPolicy) *)
record retention_policy =
  retention_max_days :: nat
  retention_auto_delete :: bool

(* NetworkZone (matches Coq: Record NetworkZone) *)
record network_zone =
  zone_id :: nat
  zone_is_cde :: bool  (* Cardholder Data Environment *)
  zone_isolated :: bool
  zone_firewall_protected :: bool

(* can_store (matches Coq: Definition can_store) *)
fun can_store :: "CHDType \<Rightarrow> bool" where
  "can_store PAN = true"
|   "can_store Expiry = true"
|   "can_store CardholderName = true"
|   "can_store CVV = false"
|   "can_store PIN = false"

(* pci_compliant_encryption (matches Coq: Definition pci_compliant_encryption) *)
fun pci_compliant_encryption :: "EncState \<Rightarrow> CHDType \<Rightarrow> bool" where
  "pci_compliant_encryption PAN = match"
|   "pci_compliant_encryption Tokenized = true"
|   "pci_compliant_encryption _ = false"

(* display_compliant (matches Coq: Definition display_compliant) *)
fun display_compliant :: "PANDisplay \<Rightarrow> bool" where
  "display_compliant FullPAN = false"
|   "display_compliant MaskedPAN = true"
|   "display_compliant TokenizedPAN = true"

(* key_needs_rotation (matches Coq: Definition key_needs_rotation) *)
definition key_needs_rotation :: "KeyState \<Rightarrow> nat \<Rightarrow> bool" where
  "key_needs_rotation k current_time \<equiv> Nat"

(* grant_chd_access - complex match, manual review needed *)

(* chd_record_compliant (matches Coq: Definition chd_record_compliant) *)
definition chd_record_compliant :: "CHDRecord \<Rightarrow> bool" where
  "chd_record_compliant rec \<equiv> andb (can_store (chd_type rec))
       (andb (pci_compliant_encryption (chd_encryption rec) (chd_type rec))
             (display_compliant (chd_display_format rec)))"

(* create_audit_entry (matches Coq: Definition create_audit_entry) *)
definition create_audit_entry :: "CHDType \<Rightarrow> bool \<Rightarrow> nat \<Rightarrow> PCIAudit" where
  "create_audit_entry chd succ prev_hash \<equiv> mkPCIAudit ts usr act chd succ (prev_hash + ts + usr + act)"

(* tls_compliant (matches Coq: Definition tls_compliant) *)
fun tls_compliant :: "TLSVersion \<Rightarrow> bool" where
  "tls_compliant TLS10 = false"
|   "tls_compliant TLS11 = false"
|   "tls_compliant TLS12 = true"
|   "tls_compliant TLS13 = true"

(* transmission_compliant (matches Coq: Definition transmission_compliant) *)
definition transmission_compliant :: "Transmission \<Rightarrow> bool" where
  "transmission_compliant t \<equiv> andb (trans_encrypted t) (tls_compliant (trans_tls_version t))"

(* data_past_retention (matches Coq: Definition data_past_retention) *)
definition data_past_retention :: "bool" where
  "data_past_retention \<equiv> Nat"

(* deletion_secure (matches Coq: Definition deletion_secure) *)
fun deletion_secure :: "DeletionState \<Rightarrow> bool" where
  "deletion_secure SecurelyDeleted = true"
|   "deletion_secure _ = false"

(* deletion_unrecoverable (matches Coq: Definition deletion_unrecoverable) *)
fun deletion_unrecoverable :: "DeletionState \<Rightarrow> bool" where
  "deletion_unrecoverable Overwritten = true"
|   "deletion_unrecoverable SecurelyDeleted = true"
|   "deletion_unrecoverable _ = false"

(* zone_compliant (matches Coq: Definition zone_compliant) *)
definition zone_compliant :: "NetworkZone \<Rightarrow> bool" where
  "zone_compliant z \<equiv> if zone_is_cde z then
    andb (zone_isolated z) (zone_firewall_protected z)
  else
    true"

(* system_scope_isolated (matches Coq: Definition system_scope_isolated) *)
definition system_scope_isolated :: "PCISystem \<Rightarrow> bool" where
  "system_scope_isolated sys \<equiv> vault_isolated (pci_vault sys)"

(* users_unique_ids (matches Coq: Definition users_unique_ids) *)
definition users_unique_ids :: "bool" where
  "users_unique_ids \<equiv> let ids := map user_id users in
  Nat"

(* COMPLY_002_01_pan_masking (matches Coq) *)
lemma COMPLY_002_01_pan_masking: "\<forall> (disp : PANDisplay), disp = FullPAN \<longrightarrow> display_compliant disp = False"
  by simp

(* COMPLY_002_01_pan_masking_valid (matches Coq) *)
lemma COMPLY_002_01_pan_masking_valid: "display_compliant MaskedPAN = True \<and> display_compliant TokenizedPAN = True"
  by auto

(* COMPLY_002_02_pan_encryption (matches Coq) *)
lemma COMPLY_002_02_pan_encryption: "\<forall> (enc : EncState), pci_compliant_encryption enc PAN = True \<longrightarrow> enc = AES256 \<or> enc = Tokenized"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_02_pan_plain_forbidden (matches Coq) *)
lemma COMPLY_002_02_pan_plain_forbidden: "pci_compliant_encryption Plain PAN = False"
  by simp

(* COMPLY_002_02_pan_aes128_insufficient (matches Coq) *)
lemma COMPLY_002_02_pan_aes128_insufficient: "pci_compliant_encryption AES128 PAN = False"
  by simp

(* COMPLY_002_03_cvv_never_stored (matches Coq) *)
lemma COMPLY_002_03_cvv_never_stored: "can_store CVV = False"
  by simp

(* COMPLY_002_03_cvv_no_compliant_encryption (matches Coq) *)
lemma COMPLY_002_03_cvv_no_compliant_encryption: "\<forall> (enc : EncState), pci_compliant_encryption enc CVV = False"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_04_pin_never_stored (matches Coq) *)
lemma COMPLY_002_04_pin_never_stored: "can_store PIN = False"
  by simp

(* COMPLY_002_04_pin_no_compliant_encryption (matches Coq) *)
lemma COMPLY_002_04_pin_no_compliant_encryption: "\<forall> (enc : EncState), pci_compliant_encryption enc PIN = False"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_05_key_rotation_detection (matches Coq) *)
lemma COMPLY_002_05_key_rotation_detection: "\<forall> (k : KeyState) (current_time : nat), key_creation_time k + key_rotation_period k < current_time \<longrightarrow> key_needs_rotation k current_time = True"
  by auto

(* COMPLY_002_05_key_no_rotation_needed (matches Coq) *)
lemma COMPLY_002_05_key_no_rotation_needed: "\<forall> (k : KeyState) (current_time : nat), current_time \<le> key_creation_time k + key_rotation_period k \<longrightarrow> key_needs_rotation k current_time = False"
  by auto

(* COMPLY_002_06_access_requires_need_to_know (matches Coq) *)
lemma COMPLY_002_06_access_requires_need_to_know: "\<forall> (u : User), user_need_to_know u = False \<longrightarrow> grant_chd_access u = False"
  by simp

(* COMPLY_002_06_no_access_level_denied (matches Coq) *)
lemma COMPLY_002_06_no_access_level_denied: "\<forall> (u : User), user_access_level u = NoAccess \<longrightarrow> grant_chd_access u = False"
  by simp

(* COMPLY_002_07_unique_ids_singleton (matches Coq) *)
lemma COMPLY_002_07_unique_ids_singleton: "\<forall> (u : User), users_unique_ids [u] = True"
  by simp

(* COMPLY_002_07_unique_ids_empty (matches Coq) *)
lemma COMPLY_002_07_unique_ids_empty: "users_unique_ids [] = True"
  by simp

(* COMPLY_002_08_mfa_required (matches Coq) *)
lemma COMPLY_002_08_mfa_required: "\<forall> (u : User), user_mfa_enabled u = False \<longrightarrow> user_access_level u \<noteq> NoAccess \<longrightarrow> grant_chd_access u = False"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_08_access_granted_implies_mfa (matches Coq) *)
lemma COMPLY_002_08_access_granted_implies_mfa: "\<forall> (u : User), grant_chd_access u = True \<longrightarrow> user_mfa_enabled u = True"
  by auto

(* COMPLY_002_09_audit_entry_has_timestamp (matches Coq) *)
lemma COMPLY_002_09_audit_entry_has_timestamp: "\<forall> (ts usr act : nat) (chd : CHDType) (succ : bool) (prev : nat), pci_timestamp (create_audit_entry ts usr act chd succ prev) = ts"
  by simp

(* COMPLY_002_09_audit_entry_has_user (matches Coq) *)
lemma COMPLY_002_09_audit_entry_has_user: "\<forall> (ts usr act : nat) (chd : CHDType) (succ : bool) (prev : nat), pci_user (create_audit_entry ts usr act chd succ prev) = usr"
  by simp

(* COMPLY_002_09_audit_entry_has_action (matches Coq) *)
lemma COMPLY_002_09_audit_entry_has_action: "\<forall> (ts usr act : nat) (chd : CHDType) (succ : bool) (prev : nat), pci_action (create_audit_entry ts usr act chd succ prev) = act"
  by simp

(* COMPLY_002_10_audit_has_hash (matches Coq) *)
lemma COMPLY_002_10_audit_has_hash: "\<forall> (ts usr act : nat) (chd : CHDType) (succ : bool) (prev : nat), pci_hash (create_audit_entry ts usr act chd succ prev) = prev + ts + usr + act"
  by simp

(* COMPLY_002_10_empty_log_valid (matches Coq) *)
lemma COMPLY_002_10_empty_log_valid: "\<forall> (h : nat), audit_chain_valid [] h = True"
  by simp

(* COMPLY_002_11_tls12_compliant (matches Coq) *)
lemma COMPLY_002_11_tls12_compliant: "tls_compliant TLS12 = True"
  by simp

(* COMPLY_002_11_tls13_compliant (matches Coq) *)
lemma COMPLY_002_11_tls13_compliant: "tls_compliant TLS13 = True"
  by simp

(* COMPLY_002_11_old_tls_non_compliant (matches Coq) *)
lemma COMPLY_002_11_old_tls_non_compliant: "tls_compliant TLS10 = False \<and> tls_compliant TLS11 = False"
  by auto

(* COMPLY_002_11_transmission_requires_encryption (matches Coq) *)
lemma COMPLY_002_11_transmission_requires_encryption: "\<forall> (t : Transmission), transmission_compliant t = True \<longrightarrow> trans_encrypted t = True"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_12_token_no_key_no_pan (matches Coq) *)
lemma COMPLY_002_12_token_no_key_no_pan: "\<forall> (vault : TokenVault) (token : nat), token_lookup vault token false = None"
  by simp

(* COMPLY_002_12_tokenization_irreversible_without_key (matches Coq) *)
lemma COMPLY_002_12_tokenization_irreversible_without_key: "\<forall> (vault : TokenVault) (token pan : nat), token_lookup vault token false = Some pan \<longrightarrow> False"
  by auto

(* COMPLY_002_13_past_retention_detected (matches Coq) *)
lemma COMPLY_002_13_past_retention_detected: "\<forall> (creation current max_days : nat), creation + max_days < current \<longrightarrow> data_past_retention creation current max_days = True"
  by auto

(* COMPLY_002_13_within_retention_ok (matches Coq) *)
lemma COMPLY_002_13_within_retention_ok: "\<forall> (creation current max_days : nat), current \<le> creation + max_days \<longrightarrow> data_past_retention creation current max_days = False"
  by auto

(* COMPLY_002_14_secure_deletion_unrecoverable (matches Coq) *)
lemma COMPLY_002_14_secure_deletion_unrecoverable: "\<forall> (ds : DeletionState), deletion_secure ds = True \<longrightarrow> deletion_unrecoverable ds = True"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_14_not_deleted_recoverable (matches Coq) *)
lemma COMPLY_002_14_not_deleted_recoverable: "deletion_unrecoverable NotDeleted = False"
  by simp

(* COMPLY_002_14_marked_still_recoverable (matches Coq) *)
lemma COMPLY_002_14_marked_still_recoverable: "deletion_unrecoverable MarkedForDeletion = False"
  by simp

(* COMPLY_002_15_cde_requires_isolation (matches Coq) *)
lemma COMPLY_002_15_cde_requires_isolation: "\<forall> (z : NetworkZone), zone_is_cde z = True \<longrightarrow> zone_compliant z = True \<longrightarrow> zone_isolated z = True"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_15_cde_requires_firewall (matches Coq) *)
lemma COMPLY_002_15_cde_requires_firewall: "\<forall> (z : NetworkZone), zone_is_cde z = True \<longrightarrow> zone_compliant z = True \<longrightarrow> zone_firewall_protected z = True"
  by (cases rule: ‹_›.cases; simp)

(* COMPLY_002_15_non_cde_always_compliant (matches Coq) *)
lemma COMPLY_002_15_non_cde_always_compliant: "\<forall> (z : NetworkZone), zone_is_cde z = False \<longrightarrow> zone_compliant z = True"
  by simp

(* COMPLY_002_15_vault_isolation (matches Coq) *)
lemma COMPLY_002_15_vault_isolation: "\<forall> (sys : PCISystem), vault_isolated (pci_vault sys) = True \<longrightarrow> system_scope_isolated sys = True"
  by auto

end
