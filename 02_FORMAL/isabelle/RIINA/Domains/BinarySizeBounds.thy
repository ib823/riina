(* Copyright (c) 2026 The RIINA Authors. All rights reserved. *)

(*
 * RIINA BinarySizeBounds - Isabelle/HOL Port
 *
 * Auto-generated port of 02_FORMAL/coq/domains/BinarySizeBounds.v (20 theorems).
 *
 * Generated by scripts/generate-multiprover.py
 *
 * Correspondence Table:
 *
 * | Coq Definition     | Isabelle Definition    | Status |
 * |--------------------|------------------------|--------|
 * | Instr              | instr                  | OK     |
 * | ArchParams         | arch_params            | OK     |
 * | Function           | function               | OK     |
 * | Module             | module                 | OK     |
 * | Program            | program                | OK     |
 * | StackFrame         | stack_frame            | OK     |
 * | InlineInfo         | inline_info            | OK     |
 * | LoopInfo           | loop_info              | OK     |
 * | GenericInfo        | generic_info           | OK     |
 * | ROMLayout          | rom_layout             | OK     |
 * | arm_cortex_m0      | arm_cortex_m0          | OK     |
 * | arm_cortex_m4      | arm_cortex_m4          | OK     |
 * | riscv32            | riscv32                | OK     |
 * | instr_size         | instr_size             | OK     |
 * | func_size          | func_size              | OK     |
 * | mod_size           | mod_size               | OK     |
 * | prog_size          | prog_size              | OK     |
 * | stack_frame_size   | stack_frame_size       | OK     |
 * | inline_expanded_size | inline_expanded_size   | OK     |
 * | unrolled_loop_size | unrolled_loop_size     | OK     |
 * | monomorphized_size | monomorphized_size     | OK     |
 * | total_rom_size     | total_rom_size         | OK     |
 * | PERF_002_01        | PERF_002_01            | OK     |
 * | PERF_002_02        | PERF_002_02            | OK     |
 * | sum_bb_sizes_app   | sum_bb_sizes_app       | OK     |
 * | PERF_002_03        | PERF_002_03            | OK     |
 * | sum_func_sizes_app | sum_func_sizes_app     | OK     |
 * | PERF_002_04        | PERF_002_04            | OK     |
 * | sum_mod_sizes_app  | sum_mod_sizes_app      | OK     |
 * | PERF_002_05        | PERF_002_05            | OK     |
 * | data_section_size_app | data_section_size_app  | OK     |
 * | PERF_002_06        | PERF_002_06            | OK     |
 * | bss_section_size_app | bss_section_size_app   | OK     |
 * | PERF_002_07        | PERF_002_07            | OK     |
 * | PERF_002_08        | PERF_002_08            | OK     |
 * | PERF_002_09        | PERF_002_09            | OK     |
 * | PERF_002_10        | PERF_002_10            | OK     |
 * | PERF_002_11        | PERF_002_11            | OK     |
 * | PERF_002_12        | PERF_002_12            | OK     |
 * | PERF_002_13        | PERF_002_13            | OK     |
 * | PERF_002_14        | PERF_002_14            | OK     |
 * | PERF_002_15        | PERF_002_15            | OK     |
 *)

theory BinarySizeBounds
  imports Main
begin

(* Instr (matches Coq: Inductive Instr) *)
datatype instr =
    INop
  |     IMov
  |     IAdd
  |     ISub
  |     IMul
  |     IDiv
  |     ILoad
  |     IStore
  |     IBranch
  |     ICall
  |     IRet

(* ArchParams (matches Coq: Record ArchParams) *)
record arch_params =
  arch_word_size :: Size  (* 4 for 32-bit, 8 for 64-bit *)
  arch_max_instr_size :: Size  (* Max instruction bytes *)
  arch_call_overhead :: Size  (* Call instruction size *)
  arch_ret_overhead :: Size  (* Return instruction size *)
  arch_flash_size :: Size  (* Total flash available *)
  arch_ram_size :: Size  (* Total RAM available *)

(* Function (matches Coq: Record Function) *)
record function =
  func_blocks :: 'a list
  func_locals :: nat  (* Local variable count *)

(* Module (matches Coq: Record Module) *)
record module =
  mod_functions :: 'a list
  mod_data :: Size  (* Initialized data *)
  mod_bss :: Size  (* Zero-initialized data *)

(* Program (matches Coq: Record Program) *)
record program =
  prog_modules :: 'a list
  prog_startup :: Size  (* Startup code size *)

(* StackFrame (matches Coq: Record StackFrame) *)
record stack_frame =
  sf_locals :: nat
  sf_saved_regs :: nat

(* InlineInfo (matches Coq: Record InlineInfo) *)
record inline_info =
  inline_original_size :: Size
  inline_call_sites :: nat

(* LoopInfo (matches Coq: Record LoopInfo) *)
record loop_info =
  loop_body_size :: Size
  loop_unroll_factor :: nat

(* GenericInfo (matches Coq: Record GenericInfo) *)
record generic_info =
  generic_template_size :: Size
  generic_instantiation_count :: nat

(* ROMLayout (matches Coq: Record ROMLayout) *)
record rom_layout =
  rom_text :: Size  (* Code section *)
  rom_rodata :: Size  (* Read-only data *)
  rom_init_data :: Size  (* Initialized data *)

(* arm_cortex_m0 (matches Coq: Definition arm_cortex_m0) *)
definition arm_cortex_m0 :: "ArchParams" where
  "arm_cortex_m0 \<equiv> mkArch 4 4 4 2 65536 8192"

(* arm_cortex_m4 (matches Coq: Definition arm_cortex_m4) *)
definition arm_cortex_m4 :: "ArchParams" where
  "arm_cortex_m4 \<equiv> mkArch 4 4 4 2 262144 65536"

(* riscv32 (matches Coq: Definition riscv32) *)
definition riscv32 :: "ArchParams" where
  "riscv32 \<equiv> mkArch 4 4 4 4 131072 32768"

(* instr_size (matches Coq: Definition instr_size) *)
definition instr_size :: "ArchParams \<Rightarrow> Instr \<Rightarrow> Size" where
  "instr_size arch i \<equiv> arch_max_instr_size arch"

(* func_size (matches Coq: Definition func_size) *)
definition func_size :: "ArchParams \<Rightarrow> Function \<Rightarrow> Size" where
  "func_size arch f \<equiv> sum_bb_sizes arch (func_blocks f) +
  arch_call_overhead arch + arch_ret_overhead arch"

(* mod_size (matches Coq: Definition mod_size) *)
definition mod_size :: "ArchParams \<Rightarrow> Module \<Rightarrow> Size" where
  "mod_size arch m \<equiv> sum_func_sizes arch (mod_functions m) + mod_data m"

(* prog_size (matches Coq: Definition prog_size) *)
definition prog_size :: "ArchParams \<Rightarrow> Program \<Rightarrow> Size" where
  "prog_size arch p \<equiv> sum_mod_sizes arch (prog_modules p) + prog_startup p"

(* stack_frame_size (matches Coq: Definition stack_frame_size) *)
definition stack_frame_size :: "ArchParams \<Rightarrow> StackFrame \<Rightarrow> Size" where
  "stack_frame_size arch sf \<equiv> sf_locals sf * arch_word_size arch + sf_saved_regs sf * arch_word_size arch"

(* inline_expanded_size (matches Coq: Definition inline_expanded_size) *)
definition inline_expanded_size :: "InlineInfo \<Rightarrow> Size" where
  "inline_expanded_size info \<equiv> inline_original_size info * inline_call_sites info"

(* unrolled_loop_size (matches Coq: Definition unrolled_loop_size) *)
definition unrolled_loop_size :: "LoopInfo \<Rightarrow> Size" where
  "unrolled_loop_size info \<equiv> loop_body_size info * loop_unroll_factor info"

(* monomorphized_size (matches Coq: Definition monomorphized_size) *)
definition monomorphized_size :: "GenericInfo \<Rightarrow> Size" where
  "monomorphized_size info \<equiv> generic_template_size info * generic_instantiation_count info"

(* total_rom_size (matches Coq: Definition total_rom_size) *)
definition total_rom_size :: "ROMLayout \<Rightarrow> Size" where
  "total_rom_size layout \<equiv> rom_text layout + rom_rodata layout + rom_init_data layout"

(* PERF_002_01 (matches Coq) *)
lemma PERF_002_01: "\<forall> (arch : ArchParams) (i : Instr), instr_size arch i \<le> arch_max_instr_size arch"
  by simp

(* PERF_002_02 (matches Coq) *)
lemma PERF_002_02: "\<forall> (arch : ArchParams) (bb : BasicBlock), bb_size arch bb = length bb * arch_max_instr_size arch"
  by simp

(* sum_bb_sizes_app (matches Coq) *)
lemma sum_bb_sizes_app: "\<forall> arch bbs1 bbs2, sum_bb_sizes arch (bbs1 ++ bbs2) = sum_bb_sizes arch bbs1 + sum_bb_sizes arch bbs2"
  by simp

(* PERF_002_03 (matches Coq) *)
lemma PERF_002_03: "\<forall> (arch : ArchParams) (f : Function), func_size arch f = sum_bb_sizes arch (func_blocks f) + arch_call_overhead arch + arch_ret_overhead arch"
  by simp

(* sum_func_sizes_app (matches Coq) *)
lemma sum_func_sizes_app: "\<forall> arch funcs1 funcs2, sum_func_sizes arch (funcs1 ++ funcs2) = sum_func_sizes arch funcs1 + sum_func_sizes arch funcs2"
  by simp

(* PERF_002_04 (matches Coq) *)
lemma PERF_002_04: "\<forall> (arch : ArchParams) (m : Module), mod_size arch m = sum_func_sizes arch (mod_functions m) + mod_data m"
  by simp

(* sum_mod_sizes_app (matches Coq) *)
lemma sum_mod_sizes_app: "\<forall> arch mods1 mods2, sum_mod_sizes arch (mods1 ++ mods2) = sum_mod_sizes arch mods1 + sum_mod_sizes arch mods2"
  by simp

(* PERF_002_05 (matches Coq) *)
lemma PERF_002_05: "\<forall> (arch : ArchParams) (p : Program), prog_size arch p = sum_mod_sizes arch (prog_modules p) + prog_startup p"
  by simp

(* data_section_size_app (matches Coq) *)
lemma data_section_size_app: "\<forall> ds1 ds2, data_section_size (ds1 ++ ds2) = data_section_size ds1 + data_section_size ds2"
  by simp

(* PERF_002_06 (matches Coq) *)
lemma PERF_002_06: "\<forall> (ds : DataSection) (var_size : Size), In var_size ds \<longrightarrow> var_size \<le> data_section_size ds"
  by (cases rule: ‹_›.cases; simp)

(* bss_section_size_app (matches Coq) *)
lemma bss_section_size_app: "\<forall> bs1 bs2, bss_section_size (bs1 ++ bs2) = bss_section_size bs1 + bss_section_size bs2"
  by simp

(* PERF_002_07 (matches Coq) *)
lemma PERF_002_07: "\<forall> (bs : BSSSection) (var_size : Size), In var_size bs \<longrightarrow> var_size \<le> bss_section_size bs"
  by (cases rule: ‹_›.cases; simp)

(* PERF_002_08 (matches Coq) *)
lemma PERF_002_08: "\<forall> (arch : ArchParams) (sf : StackFrame) (max_locals max_saved_regs : nat), sf_locals sf \<le> max_locals \<longrightarrow> sf_saved_regs sf \<le> max_saved_regs \<longrightarrow> stack_frame_size arch sf \<le> max_locals * arch_word_size arch + max_saved_regs * arch_word_size arch"
  by simp

(* PERF_002_09 (matches Coq) *)
lemma PERF_002_09: "\<forall> (info : InlineInfo) (call_overhead : Size), inline_call_sites info \<ge> 1 \<longrightarrow> inline_expanded_size info = inline_original_size info * inline_call_sites info"
  by simp

(* PERF_002_10 (matches Coq) *)
lemma PERF_002_10: "\<forall> (info : LoopInfo), unrolled_loop_size info = loop_body_size info * loop_unroll_factor info"
  by simp

(* PERF_002_11 (matches Coq) *)
lemma PERF_002_11: "\<forall> (info : GenericInfo), monomorphized_size info = generic_template_size info * generic_instantiation_count info"
  by simp

(* PERF_002_12 (matches Coq) *)
lemma PERF_002_12: "\<forall> (arch : ArchParams) (layout : ROMLayout), total_rom_size layout \<le> arch_flash_size arch \<longrightarrow> rom_text layout \<le> arch_flash_size arch \<and> rom_rodata layout \<le> arch_flash_size arch \<and> rom_init_data layout \<le> arch_flash_size arch"
  by simp

(* PERF_002_13 (matches Coq) *)
lemma PERF_002_13: "\<forall> (arch : ArchParams), bb_size arch [] = 0"
  by simp

(* PERF_002_14 (matches Coq) *)
lemma PERF_002_14: "\<forall> (arch : ArchParams) (data bss : Size), let m := mkMod [] data bss in mod_size arch m = data"
  by simp

(* PERF_002_15 (matches Coq) *)
lemma PERF_002_15: "\<forall> (t r d : Size), let layout := mkROMLayout t r d in total_rom_size layout = t + r + d"
  by simp

end
