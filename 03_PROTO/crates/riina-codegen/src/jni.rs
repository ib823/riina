// SPDX-License-Identifier: MPL-2.0
// Copyright (c) 2026 The RIINA Authors. See AUTHORS file.

//! JNI Bridge Generator
//!
//! Auto-generates Java/Kotlin JNI bindings for RIINA libraries compiled
//! to Android. The generated code loads the native `.so` and exposes
//! RIINA functions as Java methods.
//!
//! Mode: ULTRA KIASU | FUCKING PARANOID | ZERO TRUST

/// Generate a Java JNI bridge class for a RIINA library.
///
/// # Arguments
///
/// * `package` — Java package name (e.g., "com.riina.app")
/// * `class_name` — Java class name (e.g., "RiinaLib")
pub fn generate_jni_bridge(package: &str, class_name: &str) -> String {
    let lib_name = class_name.to_lowercase();
    format!(
        r#"// Auto-generated by riinac for Android target
// SPDX-License-Identifier: MPL-2.0
//
// JNI bridge for RIINA native library.
// Do not edit — regenerate with: riinac build --target=android-arm64

package {package};

/**
 * JNI bridge to RIINA native library.
 *
 * <p>All methods in this class call into verified RIINA code compiled
 * to native ARM64 via the C backend. Security properties (non-interference,
 * effect safety, type safety) are preserved by construction.</p>
 */
public class {class_name} {{

    static {{
        System.loadLibrary("{lib_name}");
    }}

    /**
     * Run the RIINA program's main entry point.
     *
     * @return The program's exit code (0 = success).
     */
    public static native int main();

    /**
     * Run RIINA verification on a source string.
     *
     * @param source The RIINA source code to verify.
     * @return true if verification passes.
     */
    public static native boolean verify(String source);

    // ================================================================
    // Runtime support methods (called FROM native code)
    // ================================================================

    /**
     * Called by RIINA's print function (cetak).
     *
     * @param message The message to print.
     */
    @SuppressWarnings("unused") // Called from native code
    private static void riinaLog(String message) {{
        android.util.Log.d("RIINA", message);
    }}

    /**
     * Called by RIINA on panic (unrecoverable error).
     *
     * @param message The panic message.
     */
    @SuppressWarnings("unused") // Called from native code
    private static void riinaPanic(String message) {{
        throw new RuntimeException("RIINA panic: " + message);
    }}
}}
"#
    )
}

/// Generate JNI C header declarations for the bridge methods.
pub fn generate_jni_header(package: &str, class_name: &str) -> String {
    let jni_prefix = format!(
        "Java_{}_{}",
        package.replace('.', "_"),
        class_name
    );
    format!(
        r#"// Auto-generated by riinac for Android target
// SPDX-License-Identifier: MPL-2.0

#ifndef RIINA_JNI_H
#define RIINA_JNI_H

#include <jni.h>

#ifdef __cplusplus
extern "C" {{
#endif

JNIEXPORT jint JNICALL {jni_prefix}_main(JNIEnv *env, jclass clazz);

JNIEXPORT jboolean JNICALL {jni_prefix}_verify(JNIEnv *env, jclass clazz, jstring source);

#ifdef __cplusplus
}}
#endif

#endif /* RIINA_JNI_H */
"#
    )
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_generate_jni_bridge() {
        let bridge = generate_jni_bridge("com.riina.app", "RiinaLib");
        assert!(bridge.contains("package com.riina.app;"));
        assert!(bridge.contains("public class RiinaLib"));
        assert!(bridge.contains("System.loadLibrary"));
        assert!(bridge.contains("native int main()"));
        assert!(bridge.contains("riinaLog"));
    }

    #[test]
    fn test_generate_jni_header() {
        let header = generate_jni_header("com.riina.app", "RiinaLib");
        assert!(header.contains("RIINA_JNI_H"));
        assert!(header.contains("Java_com_riina_app_RiinaLib_main"));
        assert!(header.contains("jni.h"));
    }
}
