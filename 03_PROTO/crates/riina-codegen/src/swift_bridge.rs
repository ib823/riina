// SPDX-License-Identifier: MPL-2.0
// Copyright (c) 2026 The RIINA Authors. See AUTHORS file.

//! Swift Bridge Generator
//!
//! Auto-generates Swift bindings for RIINA libraries compiled to iOS.
//! The generated Swift code wraps the C interface exposed through the
//! bridging header, providing a type-safe Swift API.
//!
//! Mode: ULTRA KIASU | FUCKING PARANOID | ZERO TRUST

/// Generate a Swift bridge file for a RIINA library.
///
/// # Arguments
///
/// * `module_name` — Swift module name (e.g., "RiinaLib")
pub fn generate_swift_bridge(module_name: &str) -> String {
    format!(
        r#"// Auto-generated by riinac for iOS target
// SPDX-License-Identifier: MPL-2.0
//
// Swift bridge for RIINA native library.
// Do not edit — regenerate with: riinac build --target=ios-arm64

import Foundation

/// Swift interface to verified RIINA code.
///
/// All methods call into RIINA compiled native code. Security properties
/// (non-interference, effect safety, type safety) are preserved by construction.
public class {module_name} {{

    /// Shared singleton instance.
    public static let shared = {module_name}()

    private init() {{}}

    /// Run the RIINA program's main entry point.
    ///
    /// - Returns: The program's exit code (0 = success).
    public func run() -> Int32 {{
        return riina_main()
    }}
}}

// MARK: - RIINA Value Types

/// A value returned by RIINA code, preserving type safety across the bridge.
public enum RiinaValue {{
    case unit
    case bool(Bool)
    case int(Int64)
    case float(Double)
    case string(String)

    /// Convert from the C-level `riina_value_t` struct.
    init(cValue: riina_value_t) {{
        switch cValue.tag {{
        case 0: self = .unit
        case 1: self = .bool(cValue.value.b != 0)
        case 2: self = .int(cValue.value.i)
        case 3: self = .float(cValue.value.f)
        case 4:
            if let s = cValue.value.s {{
                self = .string(String(cString: s))
            }} else {{
                self = .string("")
            }}
        default: self = .unit
        }}
    }}
}}

// MARK: - Logging Bridge

/// Called by RIINA's print function (cetak).
@_cdecl("riina_ios_log")
func riinaLog(_ message: UnsafePointer<CChar>) {{
    let msg = String(cString: message)
    NSLog("[RIINA] %@", msg)
}}

/// Called by RIINA on panic (unrecoverable error).
@_cdecl("riina_ios_panic")
func riinaPanic(_ message: UnsafePointer<CChar>) -> Never {{
    let msg = String(cString: message)
    fatalError("RIINA panic: \(msg)")
}}
"#
    )
}

/// Generate a podspec for the RIINA iOS library.
pub fn generate_podspec(module_name: &str, version: &str) -> String {
    format!(
        r#"# Auto-generated by riinac for iOS target
# SPDX-License-Identifier: MPL-2.0

Pod::Spec.new do |s|
  s.name         = '{module_name}'
  s.version      = '{version}'
  s.summary      = 'RIINA verified native library'
  s.description  = 'Formally verified code compiled from RIINA. Security properties proven in Coq.'
  s.homepage     = 'https://github.com/ib823/riina'
  s.license      = {{ :type => 'MPL-2.0', :file => 'LICENSE' }}
  s.author       = 'RIINA Authors'
  s.source       = {{ :git => 'https://github.com/ib823/riina.git', :tag => "v#{{s.version}}" }}
  s.platform     = :ios, '15.0'
  s.source_files = '*.{{c,h,swift}}'
  s.swift_version = '5.9'
end
"#
    )
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_generate_swift_bridge() {
        let bridge = generate_swift_bridge("RiinaLib");
        assert!(bridge.contains("public class RiinaLib"));
        assert!(bridge.contains("riina_main()"));
        assert!(bridge.contains("RiinaValue"));
        assert!(bridge.contains("@_cdecl"));
        assert!(bridge.contains("riinaLog"));
        assert!(bridge.contains("riinaPanic"));
    }

    #[test]
    fn test_generate_podspec() {
        let spec = generate_podspec("RiinaLib", "0.2.0");
        assert!(spec.contains("s.name         = 'RiinaLib'"));
        assert!(spec.contains("s.version      = '0.2.0'"));
        assert!(spec.contains("MPL-2.0"));
    }
}
